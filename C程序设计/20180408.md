# Unix文件系统的内部结构

2018年4月8号写的笔记，比较杂乱，等待以后整理删除。

## 磁盘 文件

- 第一层抽象 : 磁盘到分区
  - 一个磁盘可以存储大量数据，可以划分成多个独立的区域，称为分区，每个分区都可以看作是一个独立的磁盘

- 第二层抽象 : 磁盘到块序列
  - 磁盘物理上是磁性盘片，盘片表明是同心圆，称为磁道，每个磁道又被划分为固定大小(比如 512字节 )的扇区，从 0 开始对所有的扇区编号: 0 1 2 3 4 ... , 编号完成后，磁盘逻辑上的存储就是一个在 固定大小 ，序号有限，连续的存储空间上 写入数据。
- 第三层抽象 : 块序列 到 三个存储区域的划分
    - 一个被编号完的 磁盘块序列 在linux会被划分为 三个区域
    - `超级块区域` : 第一个块区域，存储文件系统本身的结构信息，例如每个区域的大小，未被使用的磁盘块
    - `i- 节点表区域` : `i-节点表`是一个列表，每条记录就是一个文件，记录结构: 文件属性 文件大小 文件最近修改时间
    - `数据区域` : 文件实际内容的保存区域

- **新建一个文件** ： 既然文件实际内容 和 文件属性信息是分开放的，那么实际进行的操作如下
    - 存储文件信息: 内核先在`i-节点表区域`找到一个未被使用的`i-node`节点(比如节点号为 47 的节点),内核把文件属性写入该节点
    - 存储文件内容: 把文件内容存入`数据区域`，记录下 `起始块` 和 `结束块` 编号, 比如 文件大小 1500 字节， 那么将占用 3 个块( 512 字节一个块 ), 存储还不要求是连续的，比如就存在 `200` `780` `1006` 三个块中 
    - 记录文件存储块号: 内核在 47 号节点的磁盘分布区，依次记录下 `200` `780` `1006`
    - 添加文件名到目录: 内核将 `文件入口( 节点号 47 , 文件名 )` 这个信息添加到目录文件中

- `目录` ： 不同版本和种类的linux`目录`的内部结构不同，但是它们的抽象模型是一致的 ：一个包含`i-节点号`和`文件名`的表
- `硬连接`的存储秘密 : `i-节点号`才是文件的唯一标识，在`目录`表中，出现同一`i-节点号`对应两个以上不同名字的，这些文件名互为`硬链接`，也就是同一个文件的多个名字

- **读取一个文件**
    - 在目录中找到文件名对应的记录，比如 `47 filename ... `
    - 在 `i-节点表区域` 定位`i-节点` 47 并且读取其内容( 所有`i-节点`大小相同 ),`i-节点`包含数据块编号的列表
    - 知道了数据块编号的列表，通过系统调用`read()`依次读取数据块上内容，不断的将字节从磁盘复制到内核缓冲区，进而到达用户空间
    - 读取一个没有权限的文件 : 内核首先在目录表上，根据文件名找到`i-节点号`，继而找到`i-节点`；在`i-节点`中，内核找到文件的权限位和拥有者的用户ID，如果权限位设置你的ID对文件没有访问权限，则`open()`系统调用返回`-1`,`errno`的值设为 `EPERM`

- 一个固定大小的`i-节点`如何存储大存储列表(大文件)
    - 解决方案: 将大存储列表存储在数据块，在`i-节点`中保存指向那些块的指针

- 简短的说，目录包含的是文件的引用，每个引用称为链接。文件的内容存储在数据块，文件的属性被记录在`i-节点`的结构中，`i-节点`的编号和文件名存储在目录中。

- 文件是一个 `i-节点` 和一些数据块的结合，链接是对`i-节点`的引用。文件没有文件名，链接有名字，对一个文件可以 创建任意多的链接。内核记录了一个文件的链接数。

- `mkdir()创建目录` ： 创建了这个目录的 `i-节点`，分配了一块磁盘块存储它的内容,在该目录中设置 `.` 和 `..` 并正确配置了它们的`i-节点号`, 在父目录中增加一个该节点的链接

- `rmdir()删除目录` : 这个目录必须只包含 `..` 和 `.`,在父目录中删除这个目录的链接,删除该目录节点，在目录未被其他进程占用的情况下，释放其 `i-节点` 和 数据块

- `unlink()删除文件` : 删除目录文件中的一个记录，减少相应 `i-节点` 的链接数.如果该 `i-节点` 的链接数减为 0 , 则数据块和`i-节点`将被释放

- `link()` : 生成一个`i-节点`的链接。新链接包含原始链接的`i-节点号`并且具有新的名字。

- `rename("y","c/y.new")` : 移动文件`mv`, 文件实际并不存在于目录中，目录存放的仅仅是它的链接。因此`rename`的基本逻辑是: 复制链接至新的名字/位置,删除原来的链接

- `chdir()` : 改变进程的当前目录，在系统内部，进程有一个存放当前目录`i-节点`的变量。从一个目录进入另一个目录，只是改变那个变量的值

## 多个文件系统的组合 : 由多棵树构成的树

- linux内核通过一些简单的抽象就能够将单一的分区组织成一颗目录树
- linux 中，每个分区都有自己的文件系统树，linux系统提供一种方法，将这些树整合成一颗更大的树
  - 每棵树都有一个根目录，一个文件系统被命名为`根文件系统`,这棵树的顶端是整棵树真正的根，其他文件系统则被附加到`根文件系统`的某个子目录上。做法是在`根文件系统`将一个目录作为指针，指向另一个文件系统的根，这样两个文件系统就联系起来了。
- `mount point` : `mount a file system`(装载文件系统) 是指将它嵌入到已有的系统以获得支撑，子树的根目录被嵌入到`根文件系统`的一个目录中，子树所在的目录称为第二个文件系统的 的 `mount point` 挂载点

- linux 允许不同种类的文件系统被装载在`根文件系统`

- 不同文件系统合成一棵树 小问题
  - `i-节点号`在一个文件系统内唯一，但在多个文件系统中，可能出现相同`i-节点号`情况
  - `link()` 拒绝跨文件系统的调用
  - `rename()` 拒绝不同文件系统间进行`i-节点`号的迁移

- `符号链接` : 通过名字引用文件，而不是`i-节点号`