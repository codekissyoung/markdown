# 内存对齐

```c
struct S
{
    char a;
    int b;
    char c;
};
```

我们先来计算一下这个结构体的大小，如果不存在内存对齐这个问题，按理说这个结构体应该占（1+4+1）6个字节；然而事实上它占了12个字节，为什么？

## 为什么存在内存对齐

原因:

- 平台原因：不是所有的硬件平台都能访问任意地址上的任意数据；某些硬件平台只能在某些特定地址处取某些特定的数据，否则就会抛出硬件异常。也就是说在计算机在内存读取数据时，只能在规定的地址处读数据，而不是内存中任意地址都是可以读取的。

- 性能问题：正是由于只能在特定的地址处读取数据，所以在访问一些数据时，对于访问未对齐的内存，处理器需要进行两次访问；而对于对齐的内存，只需要访问一次就可以。

假设只能在4的倍数的地址处读数据，即只可以访问0、4、8、12、16等地址：

![WX20190315-135046.png](https://i.loli.net/2019/03/15/5c8b3d59dda09.png)

对于上述结构体，在处理器访问`char a`时，它会从0号下标的地址处访问，而下个结构体元素 b 为`int`型，它占了4个字节，很显然，要访问它时需要先从0号下标的地址开始访问，之后还得取它后面3个字节的内容作为一部分，之后再从4号下标的地址处访问1个字节，共同的内容组成了元素 b ,很明显，访问 b 时要进行两次访问，并且很麻烦。

![WX20190315-135108.png](https://i.loli.net/2019/03/15/5c8b3d59df576.png)

如果存放数据时内存对齐了，则只需访问一次就可以读取到 b 的内容。第二幅图就是内存对齐的情况，在访问每个数据时，都可以一次性访问完毕。

## 计算内存对齐后结构体大小

- **对齐系数**：每个特定平台上的编译器都有自己的默认对齐系数，32位机一般为4，64位机一般为8，c语言中通过`#pragma pack(k)，k=1,2,4,8,16`来改变这个系数
- **对齐**: 比如`struct{ char a; short b;}`，`a`的内存位置为`0`，占一个字节，`b`的话由于需要 **对齐**，内存地址为`2`，占两个字节

规则:

- 第一个成员在与结构体变量偏移量为0的地址处。
- 先局部对齐，数据成员按照`min( 对齐系数，自身数据大小 )`对齐。
- 再整体对齐，保证结构体的大小是对齐系数的整数倍。

案例分析:

```c
struct X {
    char  x1;
    short x2;
    int   x3;
} a;

struct Y {
    char     y1;
    struct X y2;
    double   y3;
} b;

printf("sizeof(X): %ld, &x1: %p, &x2: %p,&x3: %p\n", sizeof(a), &a.x1, &a.x2, &a.x3 );
printf("sizeof(Y): %ld, &y1: %p, &y2.x1: %p, &y2.x2: %p, &y2.x3: %p, &y3: %p\n", 
        sizeof(b), &b.y1, &b.y2.x1, &b.y2.x2, &b.y2.x3, &b.y3 );
```

`#pragma pack(4)` 时：

```bash
sizeof(X): 8, &x1: 0x28, &x2: 0x2a,&x3: 0x2c
sizeof(Y): 20, &y1: 0x30, &y2.x1: 0x34, &y2.x2: 0x36, &y2.x3: 0x38, &y3: 0x3c
偏移量:
x_xx, xxxx                      0，2，4
x___, x_xx, xxxx, xxxx, xxxx    0，4，6，8，12  
```

`#pragma pack(8)` 时：

```bash
sizeof(X): 8, &x1: 0x38, &x2: 0x3a,&x3: 0x3c
sizeof(Y): 24, &y1: 0x40, &y2.x1: 0x44, &y2.x2: 0x46, &y2.x3: 0x48, &y3: 0x50
偏移量:
x_xx xxxx,                         0，2，4
x___ x_xx, xxxx ____, xxxx xxxx    0，4，6，8，16
```

看`,`分割点，是一次性能读取到到的内存，由对比可知，当**对齐系数**为8时，`12`这个内存地址，是无法读取的，所以`double y3`变量，的起始地址不能是`12`，只能往后排到`16`。也就是结构体内存需要整体对齐的意思了。