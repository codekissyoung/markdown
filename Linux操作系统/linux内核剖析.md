# linux0.12内核剖析

本文是《linux0.12剖析》一书的笔记。

## linux 0.12 发布时文件

```c
bootimage-0.12.Z  启动映像文件, 里面包含了磁盘引导扇区代码 操作系统加载程序 内核执行代码
rootimage-0.12.Z  文件系统映像文件 ,向内核提供根文件系统的支持，包括一些规定的目录 配置文件 设备驱动程序 开发程序 用户数据 和文本文件
linux-0.12.tar.Z  内核源代码文件
as86.tar.Z        Bruce Evans 的二进制文件 16位的汇编程序和装入文件
INSTALL-0.11      更新过的安装信息文件
```

linux/ 目录

```bash
boot/
fs/
include/
init/
kernel/
lib/
mm/
tools/
Makefile
```

## 目录概述

```
2. 微机系统硬件概述 IBM PC / AT 386
3. 内核的编程语言GNU C 目标文件格式 编译环境 as86 / GNU as 汇编程序
4. 80x86 cpu 体系结构 保护模式下编程 内存管理 中断 异常处理 任务管理 多任务内核示例
5. 概述linux 体系结构 内核源代码结构 每个文件大致功能 linux对物理内存的分配 内核的堆栈 虚拟线性地址的使用分配 Makefile文件
6. boot/ 目录下 磁盘引导程序bootsect.S 获取BIOS中参数程序setup.s 32位启动代码程序head.s
7. init/ 目录下 main.c 初始化程序
8. kernel/ 下 进程调度函数schedule() sleep_on()函数
9. kernel/blk_drv/ 块设备程序 硬盘 软盘
10. kernel/chr_drv/ 字符设备驱动程序 串行线路驱动程序 键盘驱动程序 和 显示器驱动程序 串行终端 控制台终端设备
11. kernel/math 数学协处理器的仿真程序
12. fs/ 文件系统程序
13. mm/ 内存管理程序
14. include/ 头文件
15. lib/ 库函数文件 主要向编译系统等系统程序提供接口函数
16. tools/  build.c 它仅用于将磁盘引导程序块 和 其他内核主要模块链接成一个完整的内核映像kernel image
17. 介绍实验环境 以及 镜像文件的制作方法
```

## I/O 端口寻址

- 外设都是通过读写设备上的寄存器来进行的，外设寄存器也称为“I/O端口”，而IO端口有两种编址方式：独立编 址和统一编制。

## 统一编址

- 外设接口中的IO寄存器（即IO端口）与主存单元一样看待，每个端口占用一个存储单元的地址，将主存的一部分划出来用作IO地址空间，如，在 PDP-11中，把最高的4K主存作为IO设备寄存器地址。端口占用了存储器的地址空间，使存储量容量减小。
- 统一编址也称为“I/O内存”方式，外设寄存器位于“内存空间”（很多外设有自己的内存、缓冲区，外设的寄存器和内存统称“I/O空间”）。
- ARM，POWERPC，MIPS都是统一编址的体系结构；
- 存储器统一编址,即从存储空间中划出一部分地址给I/O端口。CPU访问端口和访问存储器的指令在形式上完全相同，只能从地址范围来区分两种操作。
- 优点 : 对端口操作的指令类型多，功能全，不仅能对端口进行数据传送，还可以对端口内容进行算术逻辑运算和移位运算；其次是有较大的编址空间；
- 缺点 : 端口占用存储器的地址空间，使存储器的可用地址空间变小；端口指令的长度增加，执行时间变长；由于访问I/O与访问内存的指令一样，在程序中不易分清楚是访问I/O端口还是访问内存，使得阅读困难；端口地址译码器较复杂

```bash
如，Samsung的S3C2440，是32位ARM处理器，它的4GB地址空间被外设、RAM等瓜分：
0x8000 1000    LED 8*8点阵的地址
0x4800 0000 ~ 0x6000 0000  SFR（特殊暂存器）地址空间
0x3800 1002   键盘地址
0x3000 0000 ~ 0x3400 0000  SDRAM空间
0x2000 0020 ~ 0x2000 002e  IDE
0x1900 0300   CS8900
```

## 独立编址

- IO地址与存储地址分开独立编址，I/0端口地址不占用存储空间的地址范围，这样，在系统中就存在了另一种与存储地址无关的IO地址，CPU也必须具有专用与输入输出操作的IO指令（IN、OUT等）和控制逻辑。独立编址下，地址总线上过来一个地址，设备不知道是给IO端口的、还是 给存储器的，于是处理器通过MEMR/MEMW和IOR/IOW两组控制信号来实现对I/O端口和存储器的不同寻址。如，intel 80x86就采用单独编址，CPU内存和I/O是一起（‘’一起“ 应该用“各自”这个词好一点）编址的，就是说内存一部分的地址和I/O地址是重叠的。独立编址也称为“I/O端口”方式，外设寄存器位于“I/O（地址）空间”。注：x86是独立编址的体系结构，特点是它有访问IO空间的指令；
- 这种编址方式是将存储器地址空间和I/O 接口地址空间分开设置，互不影响。设有专门的输入指令（IN）和输出指令（OUT）来完成I/O 操作。
- 优点: 是内存地址空间与I/O 接口地址空间分开，互不影响，译码电路较简单，并设有专门的I/O 指令，所以编程序易于区分，且执行时间短，快速性好。
- 缺点: 是只用I/O 指令访问I/O 端口，功能有限且要采用专用I/O周期和专用I/O 控制线，使微处理器复杂化
- 查看使用的I/O 地址范围

```bash
➜  ~ sudo cat /proc/ioports
[sudo] cky 的密码：
0000-0cf7 : PCI Bus 0000:00
    0000-001f : dma1
    0020-0021 : pic1
    0040-0043 : timer0
    0050-0053 : timer1
    0060-0060 : keyboard
    0062-0062 : PNP0C09:00
    0062-0062 : EC data
    0064-0064 : keyboard
    0066-0066 : PNP0C09:00
...
```

## 接口访问控制

- 程序循环查询方式: cpu 循环查询设备控制器中的状态来判断是否可以 与 设备进行数据交换
- 中断处理: 需要中断处理器支持，I/O 设备主动向cpu请求数据交换，cpu才会暂时中断当前程序，转而处理I/O设备的请求
- 直接存储器访问 Direct Memory Access DMA , 需要专门的DMA控制器来处理，不需要cpu插手，I/O设备与系统内存之间进行批量传输数据

## BIOS

- 开机自检,建立起操作系统需要的各种表，中断向量表,硬盘参数表,把处理器和系统其余部分初始化到一个已知状态
- 开机时, CPU 自动把CS 设置为 0xF000 , IP 为 0xFFF0
- 为什么主引导记录的内存地址是0x7C00？ http://www.ruanyifeng.com/blog/2015/09/0x7c00.html

## CMOS 存储器

- 64B
- 存放实时时钟信息 和 系统硬件配置信息
- 通过I/O指令访问

## 中断控制器

- 中断向量号

## 串行通信原理

- 两台计算机通信，需要采用一致的通信协议
- 通信协议通常规定了一个有效数据长度单位的格式　，　称为"帧"
- 数据格式　: 起始位 + 数据位 + 奇偶校验位 + 停止位 等信息