# 高性能服务器编程

本文是《Linux高性能服务器编程》一书的编程笔记。

## 1. TCP/IP协议簇 

![](https://img.codekissyoung.com/2019/11/01/c611f54e46e1ccf15650594b17d4d1ed.png)

![](https://img.codekissyoung.com/2019/11/01/e6736998203d0366df5677f71a4cbfcf.png)

数据链路层：封装了物理网络的电气细节。
网络层：封装了网络链接的细节。
传输层：为应用程序封装了一条端到端的逻辑通信线路，负责数据的收发、链路的超时重连。

TCP ：协议规定，双方必须先建立链接（三次握手）才可收发数据，内核维护了连接状态、读写缓冲区、定时器等结构。数据传送是基于`字节流`，一端不断的写入，另一端不断的接收。但通信结束时，必须断开链接（四次挥手），释放内核相关结构数据。

UDP：基于数据报传输数据，每次发送的数据包的长度固定，接收时也必须一次性读取整个数据包（否则数据就被截断）。

#### 封装

![](https://img.codekissyoung.com/2019/11/02/85ad7749c95a104f1892b4986989d230.png)
![](https://img.codekissyoung.com/2019/11/02/adb5d58e87d84ce03ccbfc25df06d3a9.png)
![](https://img.codekissyoung.com/2019/11/02/c626938d9063585f1050dbdac16ee655.png)

最后封装完整的就称为`帧frame`, `MTU`最大传输单元，指的是 1 帧能携带的最大数据量，目前规定是`1500 Byte`。

#### 分用

帧到到后，根据类型，分配到对应的处理程序中的过程。

![](https://img.codekissyoung.com/2019/11/02/b6e6d113876f6a8522b23b0dd97ec472.png)

#### 测试网络

![](https://img.codekissyoung.com/2019/11/02/335e546b3b6e16989f78df6136ca6a9e.png)

#### ARP详解

目的是利用`ARP`广播，在局域网内，找到指定`IP`对应的`Mac`地址。

- [ARP原理和攻击](https://blog.51cto.com/13570193/2083332)

```bash
cky@cky-pc:~$ ifconfig          # 查询本机的 ip
enp2s0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.0.102  netmask 255.255.255.0  broadcast 192.168.0.255
        inet6 fe80::6aff:f269:1d00:8917  prefixlen 64  scopeid 0x20<link>
# 监听 这两个IP 地址之间所有 的 帧
$ sudo tcpdump -i enp2s0 -ent \
    '(dst 192.168.0.102 and src 101.200.144.41) or (dst 101.200.144.41 and src 192.168.0.102)'

$ sudo tcpdump -i enp2s0 -ent
$ sudo arp  # 查看 arp 缓存
```

#### DNS详解