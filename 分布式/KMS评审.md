## KMS 简介

- 主密钥生命周期管理: 密钥的生成、存储、分发、使用、恢复、归档与销毁
- 内置审计：可记录所有 API 请求，包括密钥管理操作和密钥使用情况
- 访问权限管理集成：通过身份管理和策略管理控制哪些账户、哪些角色可以访问或管理您的敏感密钥
- 自动定期轮换：对称加密支持自动轮转

## 方案一 主钥加密

![image-20210222154900919](https://img.codekissyoung.com/2021/02/22/335b7df5cb82fc88f7a1a442dbc4e408.png)

优点：

- 复杂度最低，不需要业务记录下加密使用的密钥

缺点：

- 敏感信息会离开xiaoyusan系统，发送给 Aliyun KMS 系统
- 数据量大的情况下，性能差
- 所有的数据都使用同一个主钥加密

## 方案二 信封加密

**企业核心数据保护**

痛点：核心知识产权、用户手机号、身份证号、银行账号、口令等隐私数据做严格保护，将敏感数据加密后保存，但是无法保证数据密钥的安全。
方案：以信封加密方式，将所有核心数据通过数据密钥加密，数据密钥再经过 KMS 加密，为核心数据提供双重保护。

### 2.1 概念流程

![image-20210222141851986](https://img.codekissyoung.com/2021/02/22/ee4a8b14844c98c1ea6393f78aa01bbf.png)

#### 加密流程

1. 首先用户需要创建一个主密钥（阿里云后台操作）
2. 调用 KMS 服务接口，获取一对数据密钥 `红钥匙` `绿钥匙`(通过主密钥加密`红钥匙`到的)
3. 用户使用`红钥匙`加密数据，得到`数据密文`，同时销毁`红钥匙`
4. 用户将`绿钥匙`和`数据密文`一同存储到数据库中

![image-20210222141926544](https://img.codekissyoung.com/2021/02/22/bac25942768f0b981257fb83f414a277.png)

#### 解密流程

1. 从数据库中取出`数据密文`和`绿钥匙`
2. 调用 KMS 接口，将`绿钥匙`解密成`红钥匙`
3. 使用`红钥匙`解密`数据密文`

![image-20210222144125005](https://img.codekissyoung.com/2021/02/22/ca4a181a23641c43ff78376d547a3489.png)

优势：

- 一条数据，一个密钥，并且密钥存储为密文
- 敏感信息不需要离开 xiaoyusan 系统，在本地加密

### GoService 方案

#### 加密流程

![image-20210222153840149](https://img.codekissyoung.com/2021/02/22/15f77355bb0667944be501569d1638ee.png)

```json
// request
{
    key1 : "data1",
    kye2 : "data2"
}

// response
{
    key1: "xxxxxxxxx",
    key2: "xxxxxxxxx",
    kms_encrypt_key: "xxxxx",
}
```

#### 解密流程

![image-20210222153914703](https://img.codekissyoung.com/2021/02/22/2f56601d09d40b90b1fce78eba72f4eb.png)

方案注意的点：

1. 绿钥匙一定要随密文一起存储，两者丢其一，则无法还原原始数据
2. 红钥匙一旦使用完毕，立刻销毁
3. Kms GoService 可以考虑记录下加密日志，备份下 密文 + 绿钥匙，预防业务方代码未存储绿钥匙的情况 

### 独立 SDK Client 方案

#### 加密

![image-20210222160532370](https://img.codekissyoung.com/2021/02/22/11ce844e80eb6c80dba7af976fd4c0eb.png)

#### 解密

![image-20210222160826604](https://img.codekissyoung.com/2021/02/22/28aba6489219df68ecc4f3b2281d3e37.png)

这个方案的优点是:

- 可以用上KMS的审计功能
- 少一层远程调用，效率高

## 方案三 自建GPG加密

GPG 加密体系，适用于安全通信

