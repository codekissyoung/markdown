# Ubuntu 18.04 LNMP 架构

## 安装脚本

首先你需要准备的是一个干净的`Ubuntu 18.04`系统，最好是刚刚安装好的，然后执行下面脚本。

```bash
#!/bin/bash
LOG_FILE="init-ubuntu-server.log";
rm ${LOG_FILE};

sudo apt-get update;
sudo apt-get upgrade;
sudo apt-get autoremove;
sudo apt-get autoclean;

sudo apt-get install nginx;
nginx -v >> ${LOG_FILE};

sudo apt-get install mysql-server mysql-client;
mysqld --version >> ${LOG_FILE};

sudo apt-get install redis-server;
redis-server --version >> ${LOG_FILE};
```

## 配置修改

确认软件是否都能正常跑起来：

```bash
pgrep -a nginx
pgrep -a php-fpm
pgrep -a mysql

sudo netstat -nat                       # 查看监听端口列表
sudo ls -i:80                           # 查看端口占用进程
sudo systemctl restart nginx.service    # 重启命令
```

下面几个命令，`dpkg -S`查看软件包安装后的所有文件清单，`.conf` 结尾单就是它们的配置了：

```bash
dpkg -S nginx | grep conf
dpkg -S php-fpm | grep conf
dpkg -S mysql | grep conf
```

`nginx`将`.php`文件，发送到`php-fpm`处理,`/etc/nginx/sites-available`中需要开启：

```bash
location ~ \.php$ {
        include snippets/fastcgi-php.conf;
#
#       # With php-fpm (or other unix sockets):
        fastcgi_pass unix:/run/php/php7.2-fpm.sock;
#       # With php-cgi (or other tcp sockets):
#       fastcgi_pass 127.0.0.1:9000;
}
```

其中，要想知道`php-fpm`到底是监听`named sock`还是`socket`,以及监听位置（或端口），则需要取查阅`php-fpm`的配置：

![](https://img.codekissyoung.com/2019/11/28/533543b1767f3962a4919d2360c973c9.png)

各项服务都重启后，在默认的 WEB 访问目录`/var/www/html`下，写个`info.php`:

```php
<?php
echo phpinfo();
```

使用浏览器访问下：

![](https://img.codekissyoung.com/2019/11/28/589f337dc964ea91d03b23ea6181db9f.png)

成功！

## MySQL 的设置 

新安装的`mysql-server`的默认用户信息都在`/etc/mysql/debian.cnf`文件里：

```mysql
[client]
host = localhost
user = debian-sys-maint
password = XUWKDk4UdNhiF5XC
socket = /var/run/mysqld/mysqld.sock
[mysql_upgrade]
host = localhost
user = debian-sys-maint
password = XUWKDk4UdNhiF5XC
socket = /var/run/mysqld/mysqld.sock
```

首先，我们先做下安全设置：

```bash
$ sudo mysql_secure_installation

New password:                           # 随便填，因为没效果 
Re-enter new password:                  # 随便填，因为没效果
Remove anonymous users?                 # y 移除匿名用户
Disallow root login remotely?           # y 不给 root 远程登录权限
Remove test database and access to it?  # 删除 test 库
```

然后我们再来设置`root`用户：

```bash
mysql -udebian-sys-maint -pXUWKDk4UdNhiF5XC     # 通过默认账户进入 MySQL
mysql> select host,user,plugin,authentication_string from mysql.user;
+-----------+------------------+-----------------------+------------------------+
| host      | user             | plugin                | authentication_string  |
+-----------+------------------+-----------------------+------------------------+
| localhost | root             | auth_socket           |                        |
| localhost | mysql.session    | mysql_native_password | *xxxxxxxxxxxxxxxxxxxxx |
| localhost | mysql.sys        | mysql_native_password | *xxxxxxxxxxxxxxxxxxxxx |
| localhost | debian-sys-maint | mysql_native_password | *xxxxxxxxxxxxxxxxxxxxx |
+-----------+------------------+-----------------------+------------------------+
```

可以看到，目前的`root`用户的插件并不是密码校验，而是用户校验，只有本机的 `root` 用户才可以登录本机的`mysql-server`

```bash
$ sudo mysql            # 直接就可以登录了
```

如果你确实是想用`mysql`的`root`用户，使用密码方式验证登录的话，那么执行：

```bash
mysql> update user set authentication_string = PASSWORD('你的密码'),
mysql> plugin = 'mysql_native_password' where user = 'root';
mysql> flush privileges;
```
