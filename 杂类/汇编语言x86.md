# 汇编语言 基于x86编译器

基于x86系列的CPU的汇编语言笔记。

## 1. 基本概念

## 2. x86 处理机架构

计算机的基本设计: CPU(有限个寄存器、高频时钟、算术逻辑单元`ALU`、控制单元`CU`)、内存存储、地址总线、控制总线、数据总线、`I/O`设备。

`ALU`只能执行加法`+`、减法`-`、与`&&`、或`||`、非`!`运算。

时钟是一个振荡器，来回震荡一次就是一个时钟周期。

CPU与总线相关的操作由时钟来进行同步，机器指令的基本时间单位是时钟周期，一条指令的执行至少需要一个时钟周期(乘法指令就需要耗费多个时钟周期)。由于访问内存速度慢于CPU,所以访问内存的指令往往会需要多个空时间周期来等待内存的响应，这称为等待状态。

CPU一秒钟的时钟周期数称为频率，现代CPU的频率已经到了`2.5G Hz`、`3.9G Hz`。

### 指令执行周期

CPU在执行一条指令时，需要经过一系列预设好的步骤，称为指令执行周期。步骤如下：

- CPU从`CS:IP`指向的内存处取得指令，然后`IP`自增指令的字节数
- CPU对指令进行 **译码**, 获知该指令需要的操作数
- 如果有操作数，则CPU从 寄存器 或 内存 中取得操作数，如果是从内存中来，`IP`还需要自增
- 拿到操作数后，CPU执行该指令，然后更新 状态寄存器 的标志位(`ZF` `CF` `OF`等)
- 如果有输出数，则CPU还要存放该结果

### 读取内存

计算机中，访问内存的速度相对于CPU来说很慢的原因是，访问寄存器只需要一个时钟周期，而访问内存需要如下操作:

- 设置地址总线的值
- 设置控制总线的值 `R` `W`
- 等待一个时钟周期给存储器芯片，将数据放置在数据总线
- 将数据总线上的数据复制到CPU中

这需要4个时钟周期才能完成，所以慢。

### 加载并执行程序

程序在磁盘里，需要操作系统使用 程序加载器 (系统工具) 加载才能运行。加载过程如下:

- 输入程序名称后，加载器依次在当前目录、`PATH`目录下找到该程序，找不到就报错
- 加载器解析 程序 的基本信息(文件大小、占用内存)
- 操作系统从内存空间中找到一块空闲的够用的内存分配给该程序，将程序的信息写入 描述符表(进程号、程序大小、内存占用)
- 操作系统将 `CS:IP` 指向程序的入口地址，程序运行
- 程序自动执行它的指令，操作系统的工作是跟踪进程的执行，并且响应程序的资源(内存、磁盘文件、输入输出)请求类型指令
- 程序运行结束，操作系统回收内存

### x86 CPU 处理器工作模式

**实地址模式**

允许 程序 直接访问 系统内存 和 硬件设备，`8086 CPU`就是这种模式，20根地址线，`1 MB` 内存寻址空间 `0000:0000 ~ FFFF:FFFF`，处理器一次只能运行一个程序，可以通过中断程序来处理来自外围设备的请求。

**保护模式**

所有指令和特性都可用，分配给程序的独立内存区域称为 段，CPU 会阻止 程序 使用自身 段 之外的内存, 32 位保护模式下，有 32 根地址线，能寻址 `4GB` 内存空间，可以同时运行多个程序，程序之间禁止意外访问其他程序的代码和数据。

**虚拟8086模式**

计算机运行在保护模式下，但可以模拟出 实地址 模式，每个模拟出来的虚拟`8086`程序，本身也只能有 `1MB` 地址空间，

**系统管理模式**

向操作系统提供了实现诸如电源管理、和系统安全等功能的机制。通常是为了某个系统而定制的处理器才会这么干。

### 64位的 x86-64 处理器

- 指令集是`x86`指令集的`64`位拓展，向后兼容`x86`指令集
- 地址长度为`64`位，但是目前只使用低`48`位，可寻址范围`0 ~ 256T`
- 拥有`64`位通用寄存器，指令支持 64 位整数操作数
- 比`x86`多了 8 个通用寄存器
- 不再支持 16位实模式 或者 虚拟8086模式

### x86-64 处理器工作模式

**64位模式**

处理器执行的是使用64位线性地址空间的应用程序。这是64位处理器的原生模式，能使用64位指令操作数。

**兼容模式**

现有的16位、32位程序不用重新编译，就可以直接运行。

### 基本64位执行环境

- 16个 64 位通用寄存器, 对比 32位CPU 只有 8个通用寄存器
- 8 个 80位浮点寄存器
- 1 个 64位标志寄存器 `RFLAGS`, 它只使用低32位
- 1 个 64位 指令指针寄存器 `RIP`

### 汇编多层次编程

汇编语言在输入输出编程领域有着强大的能力和灵活性，它们可以从以下层次进行编程选择:

- 第3层：库函数，汇编直接调用库函数来执行文本I/O，或者是基于文件的I/O
- 第2层: OS系统调用，汇编直接通过操作系统调用来执行I/O,如果OS是图形界面系统，那么汇编语言就能以与设备无关的方式来控制显示图形
- 第1层：调用BIOS函数，来控制设备的具体特性（颜色、图形、声音、键盘输入、底层磁盘I/O）
- 第0层：从硬件端口发送和接收数据，对特定设备拥有绝对控制权，比如 实模式下 直接对硬件端口进行操作，从而控制硬件























