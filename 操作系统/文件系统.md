# 文件系统

## 存储的抽象概念

### 硬件抽象:块

第一层抽象：从一块完整磁盘到分区，每个分区可视为一块磁盘

第二层抽象：每个分区切成等份的小块(512B or 4K),从0开始编号

![image-20220313174256725](https://img.codekissyoung.com/2022/03/13/73bf40712aaf24938463b86f9c057843.png)

第三层抽象: 对编号进行区域划分（文件系统决定的）,从这一步开始就是不同文件系统发挥了

- Ext2(Linux): superblock + inode table + data area
- FAT, NTFS(Windows): 略

![image-20220317203533056](https://img.codekissyoung.com/2022/03/17/7db341f2df00982125ab309b61a9958f.png)

### Linux存储抽象:文件

**superblock**：文件系统本身结构信息 ( file system type 、the size of each area )

**inode table**：单个文件的属性 (size、owner 、last modified time 、sequence of data area blocks)

> This is important：Each inode is identified by its position in the inode table. For example， inode 2 is the third struct in the inode table of the filesystem.

**data area**：data content

总结: Linux文件 = 文件系统类型 + inode (存储属性) + data(存储实际内容)

#### 大文件存储

每个inode结构的大小是固定的，它是如何做到存储有大量 data block 的文件的？

![image-20220319203231838](https://img.codekissyoung.com/2022/03/19/c8db8ae124e2f0c2921f7f8382b9e36b.png)

参考1: 三级间接存储法

### 管理抽象:目录

- 目录是一种特殊的文件，它的内容是其他文件和目录的列表
- the names in a directory refer to files and to other directories

![image-20220319205834612](https://img.codekissyoung.com/2022/03/19/789b51d0a45c5ad3749e486ef1ed8fcf.png)

#### Create File

1. Store Properties 属性
1. Store Data
1. Record Allocation 记录分配的块到属性
1. Add Filename to Directory

![image-20220317203533056](https://img.codekissyoung.com/2022/03/17/7db341f2df00982125ab309b61a9958f.png)

#### Read File

```
$ cat userlist
```

1. Search directory `.` find filename
1. get the i-node number and locate to it
1. get a list of data blocks’s number and check permission
1. read the data blocks one by one

![](https://img.codekissyoung.com/2022/03/19/fc4b34f26d258b19754867cffe4b5b78.png)

### 文件系统抽象:文件树

#### File Tree

> In Unix , every file on the system is located somewhere in a single tree directories. There are no separate drivers or volumes. In fact, directories on physically separate disks and partitions are seamlessly subsumed (无缝融入) into this single root tree (单目录树/).
>
> so we only think about directories and files when writing programs. no partitions and volumes.

Directories are linked together into a tree.

- how does this tree work?
- how are directories linked together?


![image-20220317203019291](https://img.codekissyoung.com/2022/03/17/9463525c7bcd4c5c7bae2452f5bbfd1f.png)![image-20220317203315834](https://img.codekissyoung.com/2022/03/17/cb5b6efde8c24966fc217d94215fcf1e.png)

**path** : demodir/c/dl/xlink

Root Path : / , i-node : ?



#### Hard links

如果一个文件的 filename 被写入了到了两个 directory 里了呢?

#### How Directories are connected

#### Symbolic links

#### pwd

#### mount



![image-20220313212723786](https://img.codekissyoung.com/2022/03/13/dfdf0ea4dd189ca63f77d3f95c33e27c.png)

## 回顾和展望

1. 以上都是基于Linux经典文件系统Ext2的设计作为参考进行的分享
1. 更多一个分享可以从Ext2的进化，以及和其他的文件系统的设计区别这个方向
